"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.shouldUseParallelEncoding = exports.estimateMemoryUsageForPrestitcher = void 0;
const os_1 = __importDefault(require("os"));
const estimateMemoryUsageForPrestitcher = ({ width, height, }) => {
    // Empirically we detected that per 1 million pixels, FFMPEG uses around 1GB of memory, relatively independent of
    // the duration of the video.
    const memoryUsageFor4K = 1000000000;
    const memoryUsageOfPixel = memoryUsageFor4K / 1000000;
    return memoryUsageOfPixel * width * height;
};
exports.estimateMemoryUsageForPrestitcher = estimateMemoryUsageForPrestitcher;
const shouldUseParallelEncoding = ({ width, height, }) => {
    const freeMemory = os_1.default.freemem();
    const estimatedUsage = (0, exports.estimateMemoryUsageForPrestitcher)({
        height,
        width,
    });
    const hasEnoughMemory = freeMemory - estimatedUsage > 2000000000 &&
        estimatedUsage / freeMemory < 0.5;
    return {
        hasEnoughMemory,
        freeMemory,
        estimatedUsage,
    };
};
exports.shouldUseParallelEncoding = shouldUseParallelEncoding;
