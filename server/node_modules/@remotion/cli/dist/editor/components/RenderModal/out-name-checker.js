"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateOutnameGui = exports.invalidCharacters = void 0;
const client_1 = require("@remotion/renderer/client");
exports.invalidCharacters = ['?', '*', '+', ':', '%'];
const isValidStillExtension = (extension, stillImageFormat) => {
    if (stillImageFormat === 'jpeg' && extension === 'jpg') {
        return true;
    }
    return extension === stillImageFormat;
};
const validateOutnameGui = ({ outName, codec, audioCodec, renderMode, stillImageFormat, }) => {
    try {
        isValidOutName({
            audioCodec,
            codec,
            outName,
            renderMode,
            stillImageFormat,
        });
        return { valid: true };
    }
    catch (err) {
        return { valid: false, error: err };
    }
};
exports.validateOutnameGui = validateOutnameGui;
const isValidOutName = ({ outName, codec, audioCodec, renderMode, stillImageFormat, }) => {
    const extension = outName.substring(outName.lastIndexOf('.') + 1);
    const prefix = outName.substring(0, outName.lastIndexOf('.'));
    const map = client_1.BrowserSafeApis.defaultFileExtensionMap[codec];
    if (client_1.BrowserSafeApis.supportedAudioCodecs[codec].length > 0 &&
        !(audioCodec in map.forAudioCodec)) {
        throw new Error(`Audio codec ${audioCodec} is not supported for codec ${codec}`);
    }
    const hasDotAfterSlash = () => {
        const substrings = prefix.split('/');
        for (const str of substrings) {
            if (str[0] === '.') {
                return true;
            }
        }
        return false;
    };
    const hasInvalidChar = () => {
        return prefix.split('').some((char) => exports.invalidCharacters.includes(char));
    };
    if (renderMode === 'video') {
        client_1.BrowserSafeApis.validateOutputFilename({
            codec,
            audioCodec: audioCodec !== null && audioCodec !== void 0 ? audioCodec : null,
            extension,
            preferLossless: false,
        });
    }
    if (prefix.length < 1) {
        throw new Error('The prefix must be at least 1 character long');
    }
    if (prefix[0] === '.' || hasDotAfterSlash()) {
        throw new Error('The output name must not start with a dot');
    }
    if (hasInvalidChar()) {
        throw new Error("Filename can't contain the following characters:  ?, *, +, %, :");
    }
    if (renderMode === 'still' &&
        stillImageFormat &&
        !isValidStillExtension(extension, stillImageFormat)) {
        throw new Error(`The extension ${extension} is not supported for still image format ${stillImageFormat}`);
    }
    if (renderMode === 'audio') {
        if (audioCodec === 'pcm-16') {
            if (extension !== 'wav' && extension !== 'wave') {
                throw new Error(`The extension ${extension} is not supported for audio codec ${audioCodec}`);
            }
        }
        if (audioCodec !== extension) {
            throw new Error(`The extension ${extension} is not supported for audio codec ${audioCodec}`);
        }
    }
};
