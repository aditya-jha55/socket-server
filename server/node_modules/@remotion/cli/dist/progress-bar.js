"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeRenderingAndStitchingProgress = exports.makeStitchingProgress = exports.makeRenderingProgress = exports.makeBundlingAndCopyProgress = exports.createOverwriteableCliOutput = exports.createProgressBar = void 0;
const renderer_1 = require("@remotion/renderer");
const ansi_diff_1 = require("./ansi/ansi-diff");
const chalk_1 = require("./chalk");
const config_1 = require("./config");
const download_progress_1 = require("./download-progress");
const make_progress_bar_1 = require("./make-progress-bar");
const truthy_1 = require("./truthy");
const createProgressBar = (quiet) => {
    if (!renderer_1.RenderInternals.isEqualOrBelowLogLevel(config_1.ConfigInternals.Logging.getLogLevel(), 'info')) {
        return { update: () => false };
    }
    return (0, exports.createOverwriteableCliOutput)(quiet);
};
exports.createProgressBar = createProgressBar;
const createOverwriteableCliOutput = (quiet) => {
    if (quiet) {
        return {
            update: () => false,
        };
    }
    const diff = new ansi_diff_1.AnsiDiff();
    return {
        update: (up) => process.stdout.write(diff.update(up)),
    };
};
exports.createOverwriteableCliOutput = createOverwriteableCliOutput;
const makeBundlingProgress = ({ progress, steps, doneIn, }) => [
    `(${steps.indexOf('bundling') + 1}/${steps.length})`,
    (0, make_progress_bar_1.makeProgressBar)(progress),
    `${doneIn ? 'Bundled' : 'Bundling'} code`,
    doneIn === null
        ? (progress * 100).toFixed(0) + '%'
        : chalk_1.chalk.gray(`${doneIn}ms`),
]
    .filter(truthy_1.truthy)
    .join(' ');
const makeCopyingProgress = (options) => {
    // Don't show copy progress lower than 200MB
    if (options.bytes < 1000 * 1000 * 200) {
        return null;
    }
    return [
        '    +',
        options.doneIn ? (0, make_progress_bar_1.makeProgressBar)(1) : (0, download_progress_1.getFileSizeDownloadBar)(options.bytes),
        'Copying public dir',
        options.doneIn === null ? null : chalk_1.chalk.gray(`${options.doneIn}ms`),
    ]
        .filter(truthy_1.truthy)
        .join(' ');
};
const makeSymlinkProgress = (options) => {
    if (options.symlinks.length === 0) {
        return null;
    }
    if (options.symlinks.length === 1) {
        return [
            chalk_1.chalk.gray(`      Found a symbolic link in the public folder:`),
            chalk_1.chalk.gray('      ' + options.symlinks[0]),
            chalk_1.chalk.gray('      The symlink will be forwarded in to the bundle.'),
        ].join('\n');
    }
    return [
        chalk_1.chalk.gray(`      Found ${options.symlinks.length} symbolic links in the public folder.`),
        chalk_1.chalk.gray('      The symlinks will be forwarded in to the bundle.'),
    ].join('\n');
};
const makeBundlingAndCopyProgress = ({ bundling, copying, symLinks, }) => {
    return [
        makeBundlingProgress(bundling),
        makeCopyingProgress(copying),
        makeSymlinkProgress(symLinks),
    ]
        .filter(truthy_1.truthy)
        .join('\n');
};
exports.makeBundlingAndCopyProgress = makeBundlingAndCopyProgress;
const makeRenderingProgress = ({ frames, totalFrames, steps, concurrency, doneIn, }) => {
    const progress = frames / totalFrames;
    return [
        `(${steps.indexOf('rendering') + 1}/${steps.length})`,
        (0, make_progress_bar_1.makeProgressBar)(progress),
        [doneIn ? 'Rendered' : 'Rendering', `frames (${concurrency}x)`]
            .filter(truthy_1.truthy)
            .join(' '),
        doneIn === null ? `${frames}/${totalFrames}` : chalk_1.chalk.gray(`${doneIn}ms`),
    ].join(' ');
};
exports.makeRenderingProgress = makeRenderingProgress;
const makeStitchingProgress = ({ frames, totalFrames, steps, doneIn, stage, codec, }) => {
    const progress = frames / totalFrames;
    const mediaType = codec === 'gif'
        ? 'GIF'
        : renderer_1.RenderInternals.isAudioCodec(codec)
            ? 'audio'
            : 'video';
    return [
        `(${steps.indexOf('stitching') + 1}/${steps.length})`,
        (0, make_progress_bar_1.makeProgressBar)(progress),
        stage === 'muxing' && renderer_1.RenderInternals.canUseParallelEncoding(codec)
            ? `${doneIn ? 'Muxed' : 'Muxing'} ${mediaType}`
            : `${doneIn ? 'Encoded' : 'Encoding'} ${mediaType}`,
        doneIn === null ? `${frames}/${totalFrames}` : chalk_1.chalk.gray(`${doneIn}ms`),
    ].join(' ');
};
exports.makeStitchingProgress = makeStitchingProgress;
const makeRenderingAndStitchingProgress = ({ rendering, stitching, downloads, }) => {
    return [
        (0, exports.makeRenderingProgress)(rendering),
        (0, download_progress_1.makeMultiDownloadProgress)(downloads),
        stitching === null ? null : (0, exports.makeStitchingProgress)(stitching),
    ]
        .filter(truthy_1.truthy)
        .join('\n');
};
exports.makeRenderingAndStitchingProgress = makeRenderingAndStitchingProgress;
